{"version":3,"sources":["../../src/utils/client.js"],"names":["fetch","querystring","COOKIES","clientId","process","env","CLIENT_ID","organizationId","ORGANIZATION_ID","shortCode","SHORT_CODE","siteId","SITE_ID","version","host","createUrl","prePath","postPath","query","stringify","decodeUser","req","buff","Buffer","cookies","USER","text","toString","JSON","parse","encodeUser","user","login","url","res","method","body","type","headers","token","get","data","json","getClient","refreshAuth","fetchWithToken","options","opt","Authorization","console","log","statusText","Error","api","getProduct","id","getProducts","getCategory","findProducts","getMenu","levels","getSuggestions","session","getCart","carts","customerId","total","createCart","baskets","customerInfo","email","addToCart","productId","quantity","cart","basketId","removeFromCart","itemId","updateCart","signUp","firstName","lastName","password","customer","signIn","authType"],"mappings":"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","sourcesContent":["import fetch from 'node-fetch'\nimport querystring from 'querystring'\nimport { COOKIES } from './constants'\n\nconst clientId = process.env.CLIENT_ID\nconst organizationId = process.env.ORGANIZATION_ID\nconst shortCode = process.env.SHORT_CODE\nconst siteId = process.env.SITE_ID\nconst version = 'v1'\n\nconst host = `https://${shortCode}.api.commercecloud.salesforce.com`\n\nfunction createUrl(prePath, postPath, query) {\n  return `${host}/${prePath}/${version}/organizations/${organizationId}/${postPath}?${querystring.stringify(\n    {\n      siteId,\n      ...query,\n    }\n  )}`\n}\n\nfunction decodeUser(req) {\n  try {\n    const buff = new Buffer(req.cookies[COOKIES.USER], 'base64')\n    const text = buff.toString('ascii')\n    return JSON.parse(text)\n  } catch {\n    return {}\n  }\n}\n\nexport function encodeUser(user) {\n  const buff = new Buffer(JSON.stringify(user))\n  return buff.toString('base64')\n}\n\nasync function login() {\n  const url = createUrl('customer/shopper-customers', 'customers/actions/login', {\n    clientId,\n  })\n  const res = await fetch(url, {\n    method: 'post',\n    body: JSON.stringify({\n      type: 'guest',\n    }),\n    headers: {\n      'Content-Type': 'application/json',\n    },\n  })\n  const token = res.headers.get('authorization')\n  const data = await res.json()\n  return {\n    token,\n    ...data,\n  }\n}\n\nexport default function getClient(req) {\n  let user = decodeUser(req)\n\n  async function refreshAuth() {\n    user = await login()\n  }\n\n  async function fetchWithToken(url, options) {\n    if (!user.token) {\n      await refreshAuth()\n    }\n\n    const opt = {\n      ...options,\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: user.token,\n      },\n    }\n\n    console.log('Fetching', url)\n\n    let res = await fetch(url, opt)\n\n    console.log('client status', res.statusText)\n\n    if (res.statusText === 'Unauthorized') {\n      // Token expired\n      console.log('Token expired')\n      await refreshAuth()\n      return fetchWithToken(url, options)\n    } else {\n      if (res.statusText === 'OK') {\n        return await res.json()\n      } else {\n        throw new Error(await res.text())\n      }\n    }\n  }\n\n  function api(prePath, postPath, query) {\n    const url = createUrl(prePath, postPath, query)\n    return fetchWithToken(url)\n  }\n\n  function getProduct(id, query = {}) {\n    return api('product/shopper-products', `products/${id}`, query)\n  }\n\n  function getProducts(query = {}) {\n    return api('product/shopper-products', `products`, query)\n  }\n\n  function getCategory(id, query = {}) {\n    return api('product/shopper-products', `categories/${id}`, query)\n  }\n\n  function findProducts(query = {}) {\n    return api('search/shopper-search', 'product-search', query)\n  }\n\n  // TODO: increase to 3 levels and update menu\n  function getMenu(levels = 2) {\n    return getCategory('root', { levels })\n  }\n\n  function getSuggestions(query = {}) {\n    return api('search/shopper-search', 'search-suggestions', query)\n  }\n\n  async function session() {\n    if (!user.token) {\n      console.log('No token or cust id')\n      await refreshAuth()\n    }\n  }\n\n  async function getCart() {\n    try {\n      const carts = await api('customer/shopper-customers', `customers/${user.customerId}/baskets`)\n      if (carts.total === 0) {\n        return await createCart()\n      } else {\n        return carts.baskets[0]\n      }\n    } catch {\n      // If something goes wrong, just make a new one\n      return await createCart()\n    }\n  }\n\n  function createCart() {\n    const url = createUrl('checkout/shopper-baskets', 'baskets')\n    console.log('Posting to', url)\n    return fetchWithToken(url, {\n      method: 'post',\n      body: JSON.stringify({\n        customerInfo: {\n          customerId: user.customerId,\n          email: 'test@test.com',\n        },\n      }),\n    })\n  }\n\n  async function addToCart({ productId, quantity }) {\n    const cart = await getCart()\n    const url = createUrl('checkout/shopper-baskets', `baskets/${cart.basketId}/items`)\n    return fetchWithToken(url, {\n      method: 'post',\n      body: JSON.stringify([{ productId, quantity }]),\n    })\n  }\n\n  async function removeFromCart(itemId) {\n    const cart = await getCart()\n    const url = createUrl('checkout/shopper-baskets', `baskets/${cart.basketId}/items/${itemId}`)\n    return fetchWithToken(url, {\n      method: 'delete',\n    })\n  }\n\n  async function updateCart(itemId, quantity) {\n    const cart = await getCart()\n    const url = createUrl('checkout/shopper-baskets', `baskets/${cart.basketId}/items/${itemId}`)\n    return fetchWithToken(url, {\n      method: 'patch',\n      body: JSON.stringify({ quantity }),\n    })\n  }\n\n  function signUp({ email, firstName, lastName, password, login }) {\n    const url = createUrl('customer/shopper-customers', 'customers')\n    return fetchWithToken(url, {\n      method: 'post',\n      body: JSON.stringify({\n        customer: {\n          email,\n          firstName,\n          lastName,\n          login,\n        },\n        password,\n      }),\n    })\n  }\n\n  async function signIn(email, password) {\n    const url = createUrl('customer/shopper-customers', 'customers/actions/login', { clientId })\n    const buff = new Buffer(`${email}:${password}`)\n    const opt = {\n      method: 'post',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Basic ${buff.toString('base64')}`,\n      },\n      body: JSON.stringify({\n        type: 'credentials',\n      }),\n    }\n    const res = await fetch(url, opt)\n    if (res.statusText === 'Unauthorized') {\n      throw new Error(await res.text())\n    }\n    const token = res.headers.get('authorization')\n    const data = await res.json()\n    user = {\n      token,\n      authType: data.authType,\n      customerId: data.customerId,\n      email: data.email,\n      firstName: data.firstName,\n      lastName: data.lastName,\n      login: data.login,\n    }\n    return user\n  }\n\n  return {\n    getCategory,\n    getCart,\n    session,\n    getProduct,\n    getProducts,\n    getSuggestions,\n    getMenu,\n    findProducts,\n    createCart,\n    addToCart,\n    removeFromCart,\n    updateCart,\n    signUp,\n    signIn,\n    get user() {\n      return user\n    },\n  }\n}\n"],"file":"client.js"}